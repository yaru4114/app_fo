<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bid.bo.bid.dao.BidModalDAO" >
    <select id="getSelectOpt" parameterType="com.bid.common.model.CoCmmnCdVO"
            resultType="com.bid.common.model.CoCmmnCdVO">
        SELECT *
        FROM CO_CMMN_CD
        WHERE
            MAIN_CODE = #{subCode}
        ORDER BY CODE_ORDR
    </select>

    <select id="getBrandGroupOpt" parameterType="com.bid.common.model.CoCmmnCdVO"
            resultType="com.bid.common.model.CoCmmnCdVO">
        SELECT * FROM CO_CMMN_CD
        WHERE
        MAIN_CODE = 'BRAND_GROUP_CODE'
        AND
        CODE_REFRNONE = #{subCode}
        ORDER BY CODE_ORDR
    </select>

    <select id="getBrandOpt" parameterType="com.bid.common.model.CoCmmnCdVO"
            resultType="com.bid.common.model.CoCmmnCdVO">
        SELECT *
        FROM IT_BRAND_INFO_BAS AS BRD
        INNER JOIN CO_CMMN_CD AS CMN
        ON
        BRD.BRAND_GROUP_CODE = CMN.SUB_CODE
        AND
        CMN.MAIN_CODE='BRAND_GROUP_CODE'
        WHERE
        CMN.SUB_CODE in (#{subCode})
        ORDER BY BRAND_NM
    </select>

    <select id="getItemOpt" parameterType="com.bid.common.model.CoCmmnCdVO"
            resultType="com.bid.common.model.CoCmmnCdVO">
        SELECT *
        FROM IT_ITM_INFO_BAS AS ITM
        INNER JOIN CO_CMMN_CD AS CMN
        ON
        ITM.METAL_CODE = CMN.SUB_CODE AND CMN.MAIN_CODE='METAL_CODE'
        WHERE
            CMN.SUB_CODE in (#{subCode})
        ORDER BY CODE_NM
    </select>

    <!--  ================================== 입찰 공고 등록 관련 쿼리 ================================== -->

    <insert id="creBidNotice" parameterType="com.bid.bo.bid.vo.BidNoticeVO">
        INSERT INTO BD_BID_BAS
        (
            BID_PBLANC_ID,
            METAL_CODE ,
            BRAND_GROUP_CODE ,
            BRAND_CODE ,
            ITM_SN ,
            DSTRCT_LCLSF_CODE ,
            BID_WT ,
            PERM_WT_RATE ,
            DELY_CND_01_APPLC_AT ,
            DELY_CND_01_STDR_PC ,
            DELY_CND_01_PREMIUM_PC ,
            DELY_CND_02_APPLC_AT ,
            DELY_CND_02_STDR_PC ,
            DELY_CND_02_PREMIUM_PC ,
            DELY_CND_03_APPLC_AT ,
            DELY_CND_03_STDR_PC ,
            DELY_CND_03_PREMIUM_PC ,
            DELY_BEGIN_DE ,
            DELY_END_DE ,
            DELY_PD_CN ,
            PC_APPN_BEGIN_DE ,
            PC_APPN_END_DE ,
            PC_APPN_MTH_CODE ,
            SETLE_CRNCY_CODE ,
            SETLE_MTH_CODE ,
            SETLE_PD_CODE ,
            ETC_CN ,
            BDDPR_BEGIN_DT ,
            BDDPR_END_DT ,
            BDDPR_CANCL_POSS_AT ,
            BDDPR_CANCL_LMTT_DE ,
            BID_STTUS_CODE,
            DSPY_AT ,
            FRST_REGIST_DT
        ) VALUES (
            (SELECT CODE_NM FROM CO_CMMN_CD WHERE MAIN_CODE='METAL_CODE' AND SUB_CODE= #{subCode}) + FORMAT(GETDATE(), 'yyyyMMdd') +
                RIGHT('000' + CAST(
                    (
                        (
                            SELECT TOP 1 COALESCE(CAST(RIGHT(BID_PBLANC_ID, 3) AS int) + 1, 1) AS CNT
                            FROM BD_BID_BAS
                            WHERE BID_PBLANC_ID LIKE CONCAT('%', FORMAT(GETDATE(), 'yyyyMMdd'), '%')
                            ORDER BY BID_PBLANC_ID DESC
                        )
                    ) AS NVARCHAR(3)), 3),
            #{metalCode},
            #{brandGroupCode},
            #{brandCode},
            #{itmSn},
            #{dstrctLclsfCode},
            #{bidWt},
            #{permWtRate},
            #{delyCnd01ApplcAt},
            #{delyCnd01StdrPc},
            #{delyCnd01PremiumPc},
            #{delyCnd02ApplcAt},
            #{delyCnd02StdrPc},
            #{delyCnd02PremiumPc},
            #{delyCnd03ApplcAt},
            #{delyCnd03StdrPc},
            #{delyCnd03PremiumPc},
            #{delyBeginDe},
            #{delyEndDe},
            #{delyPdCn},
            #{pcAppnBeginDe},
            #{pcAppnEndDe},
            #{pcAppnMthCode},
            #{setleCrncyCode},
            #{setleMthCode},
            #{setlePdCode},
            #{etcCn},
            #{bddprBeginDt},
            #{bddprEndDt},
            #{bddprCanclPossAt},
            #{bddprCanclLmttDe},
            #{bidSttusCode},
            #{dspyAt},
            GETDATE()
        )
    </insert>

    <update id="chgBidNotice" parameterType="com.bid.bo.bid.vo.BidNoticeVO">
        UPDATE B
        SET
            B.METAL_CODE = #{metalCode},
            B.BRAND_GROUP_CODE = #{brandGroupCode},
            B.BRAND_CODE = #{brandCode},
            B.ITM_SN = #{itmSn},
            B.DSTRCT_LCLSF_CODE = #{dstrctLclsfCode},
            B.BID_WT = #{bidWt},
            B.PERM_WT_RATE = #{permWtRate},
            B.DELY_CND_01_APPLC_AT = #{delyCnd01ApplcAt},
            B.DELY_CND_01_STDR_PC = #{delyCnd01StdrPc},
            B.DELY_CND_01_PREMIUM_PC = #{delyCnd01PremiumPc},
            B.DELY_CND_02_APPLC_AT = #{delyCnd02ApplcAt},
            B.DELY_CND_02_STDR_PC = #{delyCnd02StdrPc},
            B.DELY_CND_02_PREMIUM_PC = #{delyCnd02PremiumPc},
            B.DELY_CND_03_APPLC_AT = #{delyCnd03ApplcAt},
            B.DELY_CND_03_STDR_PC = #{delyCnd03StdrPc},
            B.DELY_CND_03_PREMIUM_PC = #{delyCnd03PremiumPc},
            B.DELY_BEGIN_DE = #{delyBeginDe},
            B.DELY_END_DE = #{delyEndDe},
            B.DELY_PD_CN = #{delyPdCn},
            B.PC_APPN_BEGIN_DE = #{pcAppnBeginDe},
            B.PC_APPN_END_DE = #{pcAppnEndDe},
            B.PC_APPN_MTH_CODE = #{pcAppnMthCode},
            B.SETLE_CRNCY_CODE = #{setleCrncyCode},
            B.SETLE_MTH_CODE = #{setleMthCode},
            B.SETLE_PD_CODE = #{setlePdCode},
            B.ETC_CN = #{etcCn},
            B.BDDPR_BEGIN_DT = #{bddprBeginDt},
            B.BDDPR_END_DT = #{bddprEndDt},
            B.BDDPR_CANCL_POSS_AT = #{bddprCanclPossAt},
            B.BDDPR_CANCL_LMTT_DE = #{bddprCanclLmttDe},
            B.BID_STTUS_CODE = #{bidSttusCode},
            B.DSPY_AT = #{dspyAt},
            B.LAST_CHANGE_DT = GETDATE(),
            U.BID_UPDT_CN = #{bidUpdtCn}
        FROM BD_BID_BAS B
        JOIN
            BD_BID_UPDT_HST U
        ON
            B.BID_PBLANC_ID = U.BID_PBLANC_ID
        WHERE
            B.BID_PBLANC_ID = #{bidPblancId};
    </update>

    <!-- 입찰 수정 이력 순번 규칙 문의해야 함. -->
    <insert id="creBidUpdt" parameterType="com.bid.bo.bid.vo.BidNoticeVO">
        INSERT INTO BD_BID_UPDT_HST
        (
            BID_UPDT_HST_SN,
            BID_PBLANC_ID,
            BID_UPDT_CN,
            BID_UPDT_RESN,
            FRST_REGIST_DT
        ) VALUES (
            #{bidPblancId},
            #{bidUpdtCn},
            #{bidUpdtResn},
            GETDATE()
        )
    </insert>

    <select id="isSelectBidUpdt" parameterType="com.bid.bo.bid.vo.BidNoticeVO" resultType="int">
        SELECT *
        FROM
            BD_BID_BAS_HST
        WHERE
            BID_PBLANC_ID = #{bidPblancId}
    </select>

    <select id="getBidDetailNoUpdt" parameterType="com.bid.bo.bid.vo.BidNoticeVO" resultType="com.bid.bo.bid.vo.BidNoticeVO">
        SELECT * FROM BD_BID_BAS
        WHERE BID_PBLANC_ID = #{bidPblancId}
    </select>

    <select id="getBidDetail" parameterType="com.bid.bo.bid.vo.BidNoticeVO" resultType="com.bid.bo.bid.vo.BidNoticeVO">
        SELECT
            B.*,
            H.BID_UPDT_CN,
            H.BID_UPDT_RESN
        FROM
            BD_BID_BAS B
        INNER JOIN
            BD_BID_UPDT_HST H
        ON
            B.BID_PBLANC_ID = H.BID_PBLANC_ID
        WHERE
            B.BID_PBLANC_ID = #{bidPblancId}
    </select>
    <!--  ================================== 입찰 공고 등록 관련 쿼리 ================================== -->
</mapper>