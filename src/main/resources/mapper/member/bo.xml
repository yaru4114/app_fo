<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bid.bo.member.dao.BdMemberDAO" >
    <select id="getMemberList" parameterType="com.bid.common.model.SearchVO" resultType="com.bid.common.model.BidMemberVO">
        SELECT
            ROW_NUMBER() OVER (ORDER BY (SELECT 1)) AS rowNo,
            BID_ENTRPS_NO,
            ENTRPS_NM,
            BID_MBER_ID,
            BSNM_REGIST_NO,
            BID_MBER_EMAIL,
            MOBLPHON_NO2,
            (CASE
                WHEN FRNTN_ENTRPS_AT = 'Y' THEN 'O'
                WHEN FRNTN_ENTRPS_AT = 'N' THEN '-'
                ELSE ''
            END) AS FRNTN_ENTRPS_AT,
            ETR_CONFM_REQUST_DT,
            ETR_CONFM_PROCESS_DT,
            BID_MBER_INTRCP_DT,
            (CASE
                WHEN BID_MBER_STTUS_CODE = '01' THEN '정상'
                WHEN BID_MBER_STTUS_CODE = '02' THEN '차단'
                ELSE ''
            END) AS BID_MBER_STTUS_CODE,
            (
                SELECT COUNT(*)
                FROM BD_BDDPR_DTL a
                INNER JOIN BD_SCSBID_DTL b ON a.BID_PBLANC_ID = b.BID_PBLANC_ID
                WHERE a.SCSBID_AT = 'Y'
                AND a.BID_ENTRPS_NO = BD_ENTRPS_INFO_BAS.BID_ENTRPS_NO
                AND b.JDGMN_STTUS_CODE = '40'
            ) AS SCSBID_CNT,
            (
                SELECT COUNT(*)
                FROM BD_BDDPR_DTL
                WHERE SCSBID_AT = 'N'
                AND BID_ENTRPS_NO = BD_ENTRPS_INFO_BAS.BID_ENTRPS_NO
            ) AS NON_SCSBID_CNT
        FROM BD_ENTRPS_INFO_BAS
        WHERE
            1 = 1
        <if test="status != null and status != '' and status != '03'">
            <choose>
                <when test="status == '00'">
                    AND (BID_MBER_STTUS_CODE = '01' OR BID_MBER_STTUS_CODE = '02')
                </when>
                <otherwise>
                    AND BID_MBER_STTUS_CODE = #{status}
                </otherwise>
            </choose>
        </if>
        <if test="searchType eq '회사명'">
            AND ENTRPS_NM LIKE '%' + #{searchKeyword} + '%'
        </if>
        <if test="searchType eq 'ID'">
            AND BID_MBER_ID LIKE '%' + #{searchKeyword} + '%'
        </if>
        <if test="searchType eq '전체'">
            AND (
                (ENTRPS_NM LIKE '%' + #{searchKeyword} + '%')
                OR (BID_MBER_ID LIKE '%' + #{searchKeyword} + '%')
            )
        </if>
        <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
            AND ETR_CONFM_REQUST_DT BETWEEN #{startDate} AND #{endDate}
        </if>
        ORDER BY BID_ENTRPS_NO DESC, rowNo ASC
    </select>

    <select id="getMemberStatusCnt" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM BD_ENTRPS_INFO_BAS
        WHERE BID_MBER_STTUS_CODE =
            CASE #{status}
                WHEN '정상 회원' THEN '01'
                WHEN '차단 회원' THEN '02'
                WHEN '가입승인대기' THEN '03'
                ELSE #{status}
            END
    </select>

    <select id="getMemberInfo" parameterType="com.bid.common.model.BidMemberVO" resultType="com.bid.common.model.BidMemberVO">
        SELECT
            BID_MBER_ID,
            BID_MBER_SECRET_NO,
            ENTRPS_NM,
            (CASE
                WHEN FRNTN_ENTRPS_AT = 'Y' THEN 'O'
                WHEN FRNTN_ENTRPS_AT = 'N' THEN '-'
                ELSE ''
            END) AS FRNTN_ENTRPS_AT,
            BSNM_REGIST_NO,
            BID_ENTRPS_NO,
            BID_MBER_EMAIL,
            MOBLPHON_NO2,
            VRSC_ENTRPS_NM,
            VRSC_BSNM_REGIST_NO,
            VRSC_BID_MBER_EMAIL,
            VRSC_MOBLPHON_NO,
            ETR_CONFM_REQUST_DT,
            ETR_CONFM_PROCESS_DT,
            (CASE
                WHEN BID_MBER_STTUS_CODE = '01' THEN '정상'
                WHEN BID_MBER_STTUS_CODE = '02' THEN '차단'
                ELSE ''
            END) AS BID_MBER_STTUS_CODE
        FROM BD_ENTRPS_INFO_BAS
        WHERE BID_ENTRPS_NO = #{bidEntrpsNo}
    </select>
    
    <update id="chgMemberBlock" parameterType="com.bid.common.model.BidMemberVO">
        UPDATE BD_ENTRPS_INFO_BAS
        <if test="bidMberSttusCode == '정상'">
            SET BID_MBER_STTUS_CODE = '02'
        </if>
        <if test="bidMberSttusCode == '차단'">
            SET BID_MBER_STTUS_CODE = '01'
        </if>
        WHERE BID_ENTRPS_NO = #{bidEntrpsNo}
    </update>

    <select id="getApprovalCnt" parameterType="com.bid.common.model.SearchVO" resultType="int">
        SELECT COUNT(*)
        FROM BD_ENTRPS_INFO_BAS AS a
        WHERE
        1 = 1
        AND BID_CONFM_STTUS_CODE IN ('01','02')
        <if test="status != null and status != ''">
            AND BID_CONFM_STTUS_CODE = #{status}
        </if>
        <if test="searchType eq '회사명'">
            AND ENTRPS_NM LIKE '%' + #{searchKeyword} + '%'
        </if>
        <if test="searchType eq 'ID'">
            AND BID_MBER_ID LIKE '%' + #{searchKeyword} + '%'
        </if>
        <if test="searchType eq '전체'">
            AND (
            (ENTRPS_NM LIKE '%' + #{searchKeyword} + '%')
            OR (BID_MBER_ID LIKE '%' + #{searchKeyword} + '%')
            )
        </if>
        <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
            AND ETR_CONFM_REQUST_DT BETWEEN #{startDate} AND #{endDate}
        </if>
    </select>

    <select id="getApprovalList" parameterType="com.bid.common.model.SearchVO" resultType="com.bid.common.model.BidMemberVO">
        SELECT
            ROW_NUMBER() OVER(ORDER BY (SELECT 1)) AS rowNo,
            ENTRPS_NM,
            BID_MBER_ID,
            BSNM_REGIST_NO,
            BID_MBER_EMAIL,
            MOBLPHON_NO2,
            FRNTN_ENTRPS_AT,
            ETR_CONFM_REQUST_DT,
            (
            CASE
                WHEN BID_CONFM_STTUS_CODE = '01' THEN '대기'
                WHEN BID_CONFM_STTUS_CODE = '02' THEN '거절'
            END
            ) AS BID_CONFM_STTUS_CODE
        FROM
            BD_ENTRPS_INFO_BAS AS a
        WHERE
            1 = 1
            AND BID_CONFM_STTUS_CODE IN ('01','02')
        <if test="status != null and status != ''">
            AND BID_CONFM_STTUS_CODE = #{status}
        </if>
        <if test="searchType eq '회사명'">
            AND ENTRPS_NM LIKE '%' + #{searchKeyword} + '%'
        </if>
        <if test="searchType eq 'ID'">
            AND BID_MBER_ID LIKE '%' + #{searchKeyword} + '%'
        </if>
        <if test="searchType eq '전체'">
            AND (
            (ENTRPS_NM LIKE '%' + #{searchKeyword} + '%')
            OR (BID_MBER_ID LIKE '%' + #{searchKeyword} + '%')
            )
        </if>
        <if test="startDate != null and startDate != '' and endDate != null and endDate != ''">
            AND ETR_CONFM_REQUST_DT BETWEEN #{startDate} AND #{endDate}
        </if>
    </select>
</mapper>